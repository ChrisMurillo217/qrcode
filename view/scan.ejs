<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link 
        rel="stylesheet" 
        href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" 
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" 
        crossorigin="anonymous">
    <!--link rel="stylesheet" href="/public/style.css"-->
    <title>QR Code</title>
</head>

<body>
    <br><br>
    <div class="container">
        <h2>Código QR generado:</h2>
        <div 
            class="card" 
            style="
                width: 10cm; 
                height: 7.5cm;">
            <img 
                class="card-img-top" 
                src=<%= qr_code %> 
                alt="QR Code" 
                style="
                    object-fit: contain; 
                    max-width: 80%; 
                    max-height: 80%;">
            <div class="card-body">
                <h5 class="card-title"><%= qr_nombre %></h5>
                <p class="card-text" style="font-size: 12px;"><%= qr_text %></p>
                <p class="card-text"><%= qr_descripcion %></p>
                <!--Ultimos cambios en estas 3 lineas-->
            </div>
        </div>
        <br>
        <div class="btn-group" role="group">
            <a href="/" type="button" class="btn btn-primary">Volver</a>
            <a href="<%= qr_code %>" download="qrcode.png" class="text-white btn btn-primary">Guardar</a>
            <a onclick="imprimirContenido()" class="text-white btn btn-primary">Imprimir</a>
        </div>
    </div>

    <script>
        function imprimirContenido() {
            var contenido = document.querySelector('.card').innerHTML;
            var ventanaImpresion = window.open('', '_blank', 'width=600,height=600');
            ventanaImpresion.document.open();
            ventanaImpresion.document.write('<html><head><title>Contenido Imprimible</title></head><body>' + contenido + '</body></html>');
            ventanaImpresion.document.close();
            ventanaImpresion.print();
        }

        // Ultimo cambio de aqui hasta el final
        app.post('/scan', (req, res, next) => {
            const input_text = req.body.text;
            const qrSize = 500; // Personaliza el tamaño del código QR

            // Consulta la base de datos para obtener el nombre y la descripción según el ID
            const query = `SELECT Nombre, Descripcion FROM tabla_prueba WHERE ID = ${input_text}`;

            sql.query(query)
                .then(result => {
                    if (result.recordset.length > 0) {
                        const nombre = result.recordset[0].Nombre;
                        const descripcion = result.recordset[0].Descripcion;

                        qrcode.toDataURL(input_text, { width: qrSize }, (err, src) => {
                            if (err) {
                                res.send('¡Algo salió mal!');
                            } else {
                                res.render('scan', {
                                    qr_code: src,
                                    qr_text: input_text,
                                    qr_nombre: nombre,
                                    qr_descripcion: descripcion
                                });
                            }
                        });
                    } else {
                        res.send('No se encontró ningún registro con el ID proporcionado');
                    }
                })
                .catch(err => {
                    console.error('Error al consultar la base de datos', err);
                    res.send('Error al consultar la base de datos');
                });
        });
    </script>    
</body>

</html>
